<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì Shared Academic Tracker</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <!-- Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.6; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .card { background: #ffffff; border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 25px; }
        h1, h2, h3 { color: #2c3e50; margin-bottom: 10px; font-weight: 600; }
        h1 { text-align: center; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        button { width: 100%; padding: 12px; background-color: #3498db; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        #all-users-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; }
        .user-card { border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; }
        footer { text-align: center; margin-top: 40px; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì Shared Academic Tracker</h1>

        <!-- Form for adding data -->
        <div class="card">
            <h2>Add / Update Your Score</h2>
            <form id="scoreForm">
                <div class="form-group">
                    <label for="userName">Your Name</label>
                    <input type="text" id="userName" placeholder="e.g., Parth" required>
                </div>
                <div class="form-group">
                    <label for="subject">Subject</label>
                    <select id="subject" required></select>
                </div>
                <div class="form-group">
                    <label for="exam">Exam</label>
                    <select id="exam" required></select>
                </div>
                <div class="form-group">
                    <label for="score">Score</label>
                    <input type="number" id="score" step="0.5" min="0" required>
                </div>
                <button type="submit">üíæ Save to Cloud</button>
            </form>
        </div>

        <!-- Container where all user dashboards will be dynamically created -->
        <div id="all-users-container"></div>
    </div>
    
    <footer>Made by Parth Soni with love ‚ù§Ô∏è</footer>

    <script>
        // --- START OF FIREBASE SETUP ---
        // PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
        const firebaseConfig = {
            apiKey: "AIzaSy...YOUR...KEY",
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef123456"
        };
        // --- END OF FIREBASE SETUP ---

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const scoresCollection = db.collection('scores');

        // --- GLOBAL CONFIG & DOM ---
        const SUBJECTS = ["Hindi", "English", "Mathematics", "Science", "SST", "AI"];
        const EXAMS = ["MT1", "MT2", "MT3", "PT1", "PT2", "Pre-boards"];
        const MAX_MARKS = { "Pre-boards": 80, "default": 40 };
        const form = document.getElementById('scoreForm');
        const allUsersContainer = document.getElementById('all-users-container');

        // --- REAL-TIME LISTENER ---
        // This is the magic! It listens for any change in the database and re-renders everything.
        scoresCollection.onSnapshot(snapshot => {
            const allUsersData = {};
            snapshot.forEach(doc => {
                allUsersData[doc.id] = doc.data();
            });
            renderDashboards(allUsersData);
        });

        // --- SAVE DATA TO FIREBASE ---
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const userName = document.getElementById('userName').value.trim().toLowerCase();
            const subject = document.getElementById('subject').value;
            const exam = document.getElementById('exam').value;
            const score = parseFloat(document.getElementById('score').value);
            
            if (!userName) {
                alert('Please enter your name!');
                return;
            }

            // Using dot notation to update a specific field within a map
            const fieldPath = `${subject}.${exam}`;
            scoresCollection.doc(userName).set({
                [subject]: {
                    [exam]: {
                        score: score,
                        max: MAX_MARKS[exam] || MAX_MARKS.default
                    }
                }
            }, { merge: true }); // {merge: true} is CRITICAL. It prevents overwriting other scores.

            alert(`Score for ${userName} saved successfully!`);
            form.reset();
        });

        // --- DYNAMICALLY RENDER ALL DASHBOARDS ---
        let charts = {}; // Keep track of chart instances to destroy them
        function renderDashboards(allUsersData) {
            allUsersContainer.innerHTML = ''; // Clear previous dashboards

            for (const userName in allUsersData) {
                const userData = allUsersData[userName];
                
                // Create a new card for each user
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <h2>${userName.charAt(0).toUpperCase() + userName.slice(1)}'s Dashboard</h2>
                    <canvas id="chart-${userName}"></canvas>
                `;
                allUsersContainer.appendChild(userCard);

                // Render the chart for that user
                const subjectAverages = {};
                for (const subject in userData) {
                    const exams = Object.values(userData[subject]);
                    const totalPercent = exams.reduce((acc, curr) => acc + (curr.score / curr.max * 100), 0);
                    subjectAverages[subject] = totalPercent / exams.length;
                }
                
                const ctx = document.getElementById(`chart-${userName}`).getContext('2d');
                if (charts[userName]) charts[userName].destroy(); // Destroy old chart before creating new one
                charts[userName] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: SUBJECTS,
                        datasets: [{
                            label: 'Average Percentage',
                            data: SUBJECTS.map(s => subjectAverages[s] || 0),
                            backgroundColor: 'rgba(52, 152, 219, 0.7)'
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true, max: 100 } } }
                });
            }
        }
        
        // --- INITIALIZE FORM DROPDOWNS ---
        const subjectSelect = document.getElementById('subject');
        const examSelect = document.getElementById('exam');
        SUBJECTS.forEach(sub => subjectSelect.innerHTML += `<option value="${sub}">${sub}</option>`);
        EXAMS.forEach(ex => examSelect.innerHTML += `<option value="${ex}">${ex}</option>`);
    </script>
</body>
</html>
